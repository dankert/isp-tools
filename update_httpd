#!/bin/bash

# Erzeugt die Virtual-Host-Konfigurationen fuer den Apache-Webserver.
#


# Konfiguration:

CONFIG=/etc/default/ispconfig

if [ ! -f $CONFIG  ]; then
    echo "File $CONFIG not found"
    exit 4;
fi

source $CONFIG


if [ ! -d $HTTPD_VHOST_DIR  ]; then
    echo "Directory $HTTPD_VHOST_DIR not found"
    exit 4;
fi

# Ggf. Mercurial-Repository anlegen.
if [ ! -d $HTTPD_VHOST_DIR/.hg ]; then
    hg -R $HTTPD_VHOST_DIR init
fi


function sql {
    sql=$1
    mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -se "$sql" $MYSQL_DATABASE
}


sql "SELECT UNIX_TIMESTAMP(modified),domain FROM domain WHERE active=1"|while read modified domain; do

    CONFFILE=$HTTPD_VHOST_DIR/$domain

    if [ ! -f $CONFFILE ]; then
	last_file_modified=0
    else
	last_file_modified=`stat --format %Y $CONFFILE`
    fi

    if	[ "$modified" -gt "$last_file_modified" ]; then

    echo "Aktualisiere $domain"
    
    # Den Benutzer zur Domain zu finden. Es ist der (hoffentlich einzige) <Benutzername>@webmaster..., der für die Domain berechtigt ist.
    user=`sql "SELECT substring_index(username,'@',1) as user FROM domain_admins where domain='$domain' and username like '%@webmaster%'"`
    echo "User: $user  ==>  Domain: $domain"
    
    
    
    if [ ! "$user" ]; then
    
    	if [ -f $HTTPD_EXTRA_CONFIG_DIR/$domain.conf ]; then
		cat > $CONFFILE <<EOF
	
# AUTO-GENERATED - DO NOT CHANGE!
# Domain: $domain
<VirtualHost *:80>
    ServerName $domain
    Include $HTTPD_EXTRA_CONFIG_DIR/$domain.conf"
</VirtualHost>
EOF
	else

		cat > $CONFFILE <<EOF
	
# AUTO-GENERATED - DO NOT CHANGE!
# Domain $domain disabled
<VirtualHost *:80>
    ServerName $domain

    RewriteEngine on
    RewriteRule (.*) - [L,R=410]
</VirtualHost>
EOF
	fi
    else
	docroot=/home/$user/var/www/$domain
	
	if [ ! -d $docroot ]; then
	    # Document-Root existiert noch nicht, also anlegen.
	    mkdir -v $docroot
	    chown -v $user $docroot
	fi
	
	if [ -f $HTTPD_EXTRA_CONFIG_DIR/$domain.conf ]; then
	    extra_config="    Include $HTTPD_EXTRA_CONFIG_DIR/$domain.conf"
	else
	    extra_config="    # No Config in $HTTPD_EXTRA_CONFIG_DIR/$domain.conf"
	fi
	if [ -f $HTTPD_MYSQL_PASSWD_DIR/$domain.passwd ]; then
	    source $HTTPD_MYSQL_PASSWD_DIR/$domain.passwd
	    echo "pass ist $mysql_password"
	    mysql_config=$(cat << EOF
php_value mysql.default_host localhost
php_value mysql.default_user $mysql_user
php_value mysql.default_password $mysql_password

php_value mysqli.default_host localhost
php_value mysqli.default_user $mysql_user
php_value mysqli.default_pw $mysql_password
EOF
)
	else
	    mysql_config="    # No Mysql Config"
	fi
    
    
	log_dir=/home/$user/var/log/apache2/$domain
	
	if [ ! -d $log_dir ]; then
	    mkdir -v $log_dir
	fi
	
	#echo "Logdir: $log_dir"
	
	if [ -f /etc/ssl/local/cert/$domain.crt ]; then
	    crt=/etc/ssl/local/cert/$domain.crt
	else
	    crt=/etc/ssl/local/cert/webmail.weiherhei.de.crt
	fi
	key=/etc/ssl/local/server.key
	
	
	
	
	cat > $CONFFILE <<EOF
	
# AUTO-GENERATED - DO NOT CHANGE!
# Domain $domain User: $user
<VirtualHost *:80>
    ServerName $domain
    ServerAdmin webmaster@$domain

    DocumentRoot $docroot

    php_admin_value sendmail_path "/usr/sbin/sendmail -t -i -r webmaster@$domain"
    php_admin_value open_basedir /home/$user/var/www/$domain:/home/$user/tmp
    php_admin_value upload_tmp_dir /home/$user/tmp

    ErrorLog $log_dir/error.log
    CustomLog $log_dir/access.log combined
    
    $extra_config
    
    $mysql_config
</VirtualHost>

<VirtualHost *:443>
    ServerName $domain
    ServerAdmin webmaster@$domain

    DocumentRoot $docroot

    php_admin_value sendmail_path "/usr/sbin/sendmail -t -i -r webmaster@$domain"
    php_admin_value open_basedir /home/$user/var/www/$domain:/home/$user/tmp
    php_admin_value upload_tmp_dir /home/$user/tmp

    ErrorLog $log_dir/error.log
    CustomLog $log_dir/access.log combined
    
    $extra_config
    $mysql_config
    
    
    SSLEngine on
    SSLCertificateFile    $crt
    SSLCertificateKeyFile $key
    
    SSLProtocol All -SSLv2 -SSLv3
    #SSLCipherSuite HIGH:MEDIUM
    
    SSLHonorCipherOrder On
    SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS

</VirtualHost>

EOF
	



    fi

    fi
    


done


# Apache-Webserver muss Konfiguration neu laden
if [ `hg -R $HTTPD_VHOST_DIR status -m -a -u|wc -l` -gt 0 ]; then

    echo "Änderungen durchgeführt:"
    hg -R $HTTPD_VHOST_DIR diff
    hg -R $HTTPD_VHOST_DIR commit -A -u `whoami` -m "Updating HTTPD configuration"


    if [ ! `apache2ctl -t|grep "Syntax OK"|wc -l` -eq "0" ]; then
	echo "Apache-Konfiguraton ist fehlerhaft! Kein Restart!"
	apache2ctl -t
    else
	echo "Apache-Konfiguration ist OK."
	echo "Reloading Apache Webserver."
	apache2ctl restart 
    fi
fi

