#!/bin/bash

# Erzeugt die Virtual-Host-Konfigurationen fuer den Apache-Webserver.
#


# Konfiguration:

CONFIG=/etc/default/ispconfig

if [ ! -f $CONFIG  ]; then
    echo "File $CONFIG not found"
    exit 4;
fi

source $CONFIG


if [ ! -f $HTTP_VHOST_DIR  ]; then
    echo "File $HTTP_VHOST_DIR not found"
    exit 4;
fi

if [ ! -d $HTTPD_VHOST_DIR/.hg ]; then
    hg -R $HTTPD_VHOST_DIR init
fi


function sql {
    sql=$1
    mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -se "$sql" $MYSQL_DATABASE
}


sql "SELECT UNIX_TIMESTAMP(modified),domain FROM domain WHERE active=1"|while read modified domain; do

    CONFFILE=$HTTPD_VHOST_DIR/$domain

    if [ ! -f $CONFFILE ]; then
	last_file_modified=0
    else
	last_file_modified=`stat --format %Y $CONFFILE`
    fi

    if	[ "$modified" -gt "$last_file_modified" ]; then

    echo "Aktualisiere $domain"
    
    # Versuchen, den Benutzer zur Domain zu finden.
    dir=`find /home -mindepth 4 -maxdepth 4 -path "/home/*/var/www/*" -type d -name "$domain"`
    user=`echo $dir|cut -f 3 -d "/"`
    #echo "User: $user  ==>  Domain: $domain"
    
    if [ ! "$user" ]; then
    
	cat > $CONFFILE <<EOF
	
# AUTO-GENERATED by $0 - DO NOT CHANGE!
<VirtualHost *>
    ServerName $domain

    RewriteEngine on
    RewriteRule (.*) - [L,R=410]
</VirtualHost>
EOF
    else
	#echo "Pruefe $HTTPD_EXTRA_CONFIG_DIR/$domain.conf"
	if [ -f $HTTPD_EXTRA_CONFIG_DIR/$domain.conf ]; then
	    extra_config="    Include $HTTPD_EXTRA_CONFIG_DIR/$domain.conf"
	else
	    extra_config=
	fi
    
	log_dir=/home/$user/var/log/apache2/$domain
	
	if [ ! -d $log_dir ]; then
	    echo "Lege an: $log_dir"
	    mkdir $log_dir
	fi
	#echo "Logdir: $log_dir"
	
	
	
	
	
	cat > $CONFFILE <<EOF
	
# AUTO-GENERATED by $0 - DO NOT CHANGE!
<VirtualHost *>
    ServerName $domain
    ServerAdmin webmaster@$domain

    DocumentRoot /home/$user/var/www/$domain

    php_admin_value sendmail_path "/usr/sbin/sendmail -t -i -r webmaster@$domain"
    php_admin_value open_basedir /home/$user/var/www/$domain:/home/$user/tmp
    php_admin_value upload_tmp_dir /home/$user/tmp

    ErrorLog $log_dir/error.log
    CustomLog $lor_dir/access.log combined
    
    $extra_config
</VirtualHost>
EOF

	hg -R $HTTPD_VHOST_DIR add $CONFFILE

    fi
    fi
    


done


# Apache-Webserver muss Konfiguration neu laden
if [ `hg -R $HTTPD_VHOST_DIR status|wc -l` -gt 0 ]; then

    echo "Änderungen durchgeführt"
    hg -R $HTTPD_VHOST_DIR diff
    hg -R $HTTPD_VHOST_DIR commit -u `whoami` -m "Updating HTTPD configuration"


    if [ ! `apache2ctl -t|grep "Syntax OK"|wc -l` -eq "0" ]; then
	echo "Apache-Konfiguraton ist fehlerhaft! Kein Restart."
	#apache2ctl -t
    else
	echo "Apache-Konfiguration ist OK."
	echo "Reloading Apache Webserver."
	#apache2ctl restart 
    fi
fi

