#!/bin/bash

# Datenbank
MYSQL_USER=cron
MYSQL_PASSWORD=twGeL8nKbECs5aKU
MYSQL_DATABASE=verwaltung

function sql {
    sql=$1
    mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -se "$sql" $MYSQL_DATABASE
}



function create_map {
    mapfile=/etc/postfix/ldap/$1
    sql=$2
    echo "# AUTO-GENERATED - DO NOT CHANGE!" > $mapfile
    sql "$sql"|while read key value; do
	echo $key $value >> $mapfile
    done
    echo "" >> $mapfile
    
    #hg diff
    hg add $mapfile
    hg commit -u `whoami` -m "Updating Postfix configuration in $mapfile" $mapfile
    /usr/sbin/postmap $mapfile
}



create_map transport        "select distinct domain,'virtual:' from mailbox where active=1"
create_map aliases          "select address,goto from alias where active=1"
create_map sender           "select concat(local_part,'@',domain),concat(local_part,'@',domain) from mailbox where active=1"
create_map virtualforward   "select '# n/a','' from mailbox where active=1"
create_map accounts         "select concat(local_part,'@',domain) , concat(maildir,'/') from mailbox where active=1"
create_map accountsmap      "select concat(local_part,'@',domain) , concat(local_part,'@',domain) from mailbox where active=1"
create_map recipient_reject "select concat(local_part,'@',domain), 'REJECT' from mailbox where active=0"

postfix reload
