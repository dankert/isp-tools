#!/bin/bash

CONFIG=/etc/default/ispconfig

if [ ! -f $CONFIG  ]; then
    echo "File $CONFIG not found"
    exit 4;
fi

source $CONFIG


# Datenbank
function sql {
    sql=$1
    mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -se "$sql" $MYSQL_DATABASE
}



function create_map {
    mapfile=$MTA_CONFIG_DIR/$1
    sql=$2
    echo "# AUTO-GENERATED BY $0 - DO NOT CHANGE!" > $mapfile
    sql "$sql"|while read key value; do
	echo $key $value >> $mapfile
    done
    echo "" >> $mapfile
    
    # Adding to SCM
    hg -R $MTA_CONFIG_DIR add $mapfile
    
    # Compile Postfix map
    /usr/sbin/postmap $mapfile
}


last_mail_modified=`sql "select unix_timestamp(max(modified)) FROM (select modified from mailbox union all select modified FROM alias) as modified"`
last_file_modified=`stat --format %Y $MTA_CONFIG_DIR/transport`

if [ ! "$last_mail_modified" -gt "$last_file_modified" ]; then
    exit 0; # all up to date, nothing to do.
fi



create_map transport        "select distinct domain,'virtual:' from mailbox where active=1"
create_map aliases          "select address,goto from alias where active=1"
create_map sender           "select concat(local_part,'@',domain),concat(local_part,'@',domain) from mailbox where active=1"
create_map virtualforward   "select '# n/a','' from mailbox where active=1"
create_map accounts         "select concat(local_part,'@',domain) , concat(maildir,'/') from mailbox where active=1"
create_map accountsmap      "select concat(local_part,'@',domain) , concat(local_part,'@',domain) from mailbox where active=1"
create_map recipient_reject "select concat(local_part,'@',domain), 'REJECT' from mailbox where active=0"

hg -R $MTA_CONFIG_DIR diff
hg -R $MTA_CONFIG_DIR commit -u `whoami` -m "Updating Postfix configuration"

postfix reload
